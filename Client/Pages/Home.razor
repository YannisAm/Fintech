@using Fintech.Shared.Models;
@using Microsoft.AspNetCore.Components;
@using System.Security.Claims;

@page "/home"

<MudLayout Class="align-content-start">
    <MudContainer MaxWidth="MaxWidth.ExtraSmall" >
        <MudSelect Value="SelectedPortfolio" T="Fintech.Shared.Models.Portfolio" Label="Portfolio" AnchorOrigin="Origin.BottomCenter" FullWidth="true" SelectedValuesChanged="@((Portfolio) => HandleSelectionChanged(SelectedPortfolio))">
            @foreach (var portfolio in Portfolios)
            {
                <MudSelectItem Value="@(portfolio)">@portfolio.NameOfPortfolio</MudSelectItem>
            }
        </MudSelect>
    </MudContainer>
    <MudDivider />
    <MudChart ChartType="ChartType.Pie" InputData="@Data" InputLabels="@Labels" Width="300px" Height="300px" />
</MudLayout>

@code{

    [Inject]
    public IPortfolioService PortfolioService { get; set; }
    [Inject]
    public ISecurityService SecurityService { get; set; }
    [Inject]
    public AuthenticationStateProvider AuthenticationState { get; set; }
    private string userEmail;

    private List<Fintech.Shared.Models.Portfolio> Portfolios = new();
    private List<Fintech.Shared.Models.Security> Securities = new();
    public Fintech.Shared.Models.Portfolio Portfolio { get; set; }
    public Fintech.Shared.Models.Portfolio SelectedPortfolio { get; set; }
    public double[] Data { get; set; }
    public string[] Labels { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationState.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity.IsAuthenticated)
        {
            var claimsIdentity = (ClaimsIdentity)user.Identity;
            var userIdClaim = claimsIdentity.FindFirst(ClaimTypes.Name);
            userEmail = userIdClaim?.Value;
        }

        Portfolios = await PortfolioService.GetPortfolios(userEmail);
        Securities = await SecurityService.GetSecurities(userEmail);
    }

    private void HandleSelectionChanged(Fintech.Shared.Models.Portfolio SelectedPortfolio)
    {
        Console.WriteLine(SelectedPortfolio.NameOfPortfolio);
        Console.WriteLine(5);
    }
}
